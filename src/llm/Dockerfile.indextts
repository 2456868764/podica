FROM python:3.11-slim

ENV LANG=C.UTF-8
ENV DEBIAN_FRONTEND=noninteractive

ARG ARCH="cpu"

# Install system dependencies required for IndexTTS
RUN apt-get update -y && apt-get install -y --no-install-recommends --fix-missing \
    build-essential \
    gcc \
    g++ \
    make \
    cmake \
    pkg-config \
    libffi-dev \
    libssl-dev \
    libsndfile1 \
    libsndfile1-dev \
    ffmpeg \
    espeak \
    espeak-data \
    libespeak1 \
    libespeak-dev \
    git \
    wget \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /home/llm

# Copy requirements files
COPY requirements_indextts.txt /home/llm/requirements_indextts.txt

# Install Python dependencies
RUN pip install --no-cache-dir --upgrade pip setuptools wheel && \
    pip install --no-cache-dir -r /home/llm/requirements_indextts.txt

# Install spacy and download language models
RUN pip install spacy && \
    python -m spacy download en_core_web_sm

# Copy application code
COPY . /home/llm

# Set environment variables
ENV PYTHONPATH=$PYTHONPATH:/home/llm
ENV TTS_PROVIDER=index-tts

# Create necessary directories
RUN mkdir -p /home/llm/logs \
    /home/llm/checkpoints/hf_cache \
    /home/llm/checkpoints/IndexTeam

# Expose port
EXPOSE 9000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:9000/health || exit 1

# Entry point
ENTRYPOINT ["python", "service.py"]

